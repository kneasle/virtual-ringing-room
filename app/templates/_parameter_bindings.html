<!-- Load mousetrap -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.6.5/mousetrap.min.js" integrity="sha512-+Jg3Ynmj9hse704K48H6rBBI3jdNBjReRGBCxUWFfOz3yVurnJFWtAWssDAsGtzWYw89xFWPxShuj2T6E9EOpg==" crossorigin="anonymous"></script>

<!-- bind tower data -->
<script>
window.tower_parameters = {
    id: parseInt({{tower.tower_id}}),
    name: "{{tower.name | safe}}",
    audio: "{{tower.audio}}",
    size: parseInt({{tower.n_bells}}),
    observers: parseInt({{tower.observers}}),
    assignments: {{tower.assignments_as_list() | safe }},
    sizes_available: {{ [4,5,6,8,10,12,14,16] if tower.additional_sizes_enabled else [4,6,8,10,12]}},
    cur_user_id: "{{user_id}}",
    cur_user_name: "{{user_name}}",
    cur_user_email: "{{user_email}}",
    cur_user_badge: "{{user_badge if user_badge else ''}}",
    cur_user_is_creator: {{'true' if tower.creator == current_user else 'false'}},
    anonymous_user: {{'true' if current_user.is_anonymous or listen_link else 'false'}},
    user_token: "{{user_token}}",
    host_mode_permitted: {{'true' if tower.host_mode_enabled else 'false'}},
    host_mode: {{'true' if tower.host_mode else 'false'}},
    host_permissions: {{'true' if host_permissions else 'false'}},
    half_muffled: {{'true' if tower.half_muffled else 'false'}},
    anticlockwise: {{'true' if tower.anticlockwise else 'false'}},
    bookmarked: {{'true' if current_user.is_authenticated and current_user.bookmarked(tower.tower_id) else 'false'}},
    listen_link: {{'true' if listen_link else 'false'}},
    server_ip: "{{server_ip}}",
    cow_enabled: {{'true' if tower.cowbell_enabled else 'false'}},
};

{% if not listen_link %}

window.user_settings = {
        controller_debounce: parseInt({{user_settings['controllers']['debounce']}}),
        controller_handstroke: parseInt({{user_settings['controllers']['handstroke']}}),
        controller_backstroke: parseInt({{user_settings['controllers']['backstroke']}}),
        controller_left_left: "{{user_settings['controllers']['left_left']}}",
        controller_left_right: "{{user_settings['controllers']['left_right']}}",
        controller_right_left: "{{user_settings['controllers']['right_left']}}",
        controller_right_right: "{{user_settings['controllers']['right_right']}}",
};


_bind_hotkeys = function(bell_obj) {

    // Escape to unfocus chatbox
    Mousetrap.bind('escape',  () => {if ($("#chat_input_box").is(":focus")) $("#chat_input_box").blur();});

    // shift+s to set at hand
    Mousetrap.bind({{user_settings['keybindings']['set_at_hand'] | safe }}, bell_obj.set_bells_at_hand);
    // Ring specific bell
    Mousetrap.bind({{user_settings['keybindings']['1'] | safe}}, ()=>bell_obj.pull_rope(1))
    Mousetrap.bind({{user_settings['keybindings']['2'] | safe}}, ()=>bell_obj.pull_rope(2))
    Mousetrap.bind({{user_settings['keybindings']['3'] | safe}}, ()=>bell_obj.pull_rope(3))
    Mousetrap.bind({{user_settings['keybindings']['4'] | safe}}, ()=>bell_obj.pull_rope(4))
    Mousetrap.bind({{user_settings['keybindings']['5'] | safe}}, ()=>bell_obj.pull_rope(5))
    Mousetrap.bind({{user_settings['keybindings']['6'] | safe}}, ()=>bell_obj.pull_rope(6))
    Mousetrap.bind({{user_settings['keybindings']['7'] | safe}}, ()=>bell_obj.pull_rope(7))
    Mousetrap.bind({{user_settings['keybindings']['8'] | safe}}, ()=>bell_obj.pull_rope(8))
    Mousetrap.bind({{user_settings['keybindings']['9'] | safe}}, ()=>bell_obj.pull_rope(9))
    Mousetrap.bind({{user_settings['keybindings']['10'] | safe}}, ()=>bell_obj.pull_rope(10))
    Mousetrap.bind({{user_settings['keybindings']['11'] | safe}}, ()=>bell_obj.pull_rope(11))
    Mousetrap.bind({{user_settings['keybindings']['12'] | safe}}, ()=>bell_obj.pull_rope(12))
    Mousetrap.bind({{user_settings['keybindings']['13'] | safe}}, ()=>bell_obj.pull_rope(13))
    Mousetrap.bind({{user_settings['keybindings']['14'] | safe}}, ()=>bell_obj.pull_rope(14))
    Mousetrap.bind({{user_settings['keybindings']['15'] | safe}}, ()=>bell_obj.pull_rope(15))
    Mousetrap.bind({{user_settings['keybindings']['16'] | safe}}, ()=>bell_obj.pull_rope(16))
    //Rotate to bell
    Mousetrap.bind({{user_settings['keybindings']['rotate-1'] | safe}}, ()=>bell_obj.rotate(1))
    Mousetrap.bind({{user_settings['keybindings']['rotate-2'] | safe}}, ()=>bell_obj.rotate(2))
    Mousetrap.bind({{user_settings['keybindings']['rotate-3'] | safe}}, ()=>bell_obj.rotate(3))
    Mousetrap.bind({{user_settings['keybindings']['rotate-4'] | safe}}, ()=>bell_obj.rotate(4))
    Mousetrap.bind({{user_settings['keybindings']['rotate-5'] | safe}}, ()=>bell_obj.rotate(5))
    Mousetrap.bind({{user_settings['keybindings']['rotate-6'] | safe}}, ()=>bell_obj.rotate(6))
    Mousetrap.bind({{user_settings['keybindings']['rotate-7'] | safe}}, ()=>bell_obj.rotate(7))
    Mousetrap.bind({{user_settings['keybindings']['rotate-8'] | safe}}, ()=>bell_obj.rotate(8))
    Mousetrap.bind({{user_settings['keybindings']['rotate-9'] | safe}}, ()=>bell_obj.rotate(9))
    Mousetrap.bind({{user_settings['keybindings']['rotate-10'] | safe}}, ()=>bell_obj.rotate(10))
    Mousetrap.bind({{user_settings['keybindings']['rotate-11'] | safe}}, ()=>bell_obj.rotate(11))
    Mousetrap.bind({{user_settings['keybindings']['rotate-12'] | safe}}, ()=>bell_obj.rotate(12))
    Mousetrap.bind({{user_settings['keybindings']['rotate-13'] | safe}}, ()=>bell_obj.rotate(13))
    Mousetrap.bind({{user_settings['keybindings']['rotate-14'] | safe}}, ()=>bell_obj.rotate(14))
    Mousetrap.bind({{user_settings['keybindings']['rotate-15'] | safe}}, ()=>bell_obj.rotate(15))
    Mousetrap.bind({{user_settings['keybindings']['rotate-16'] | safe}}, ()=>bell_obj.rotate(16))
    // Right hand
    Mousetrap.bind({{user_settings['keybindings']['right'] | safe}},
                   ()=>{bell_obj.pull_rope_by_hand("right"); return false}, 
                   'keydown');
    Mousetrap.bind({{user_settings['keybindings']['left'] | safe}},
                   ()=>{bell_obj.pull_rope_by_hand("left"); return false}, 
                   'keydown');
    Mousetrap.bind({{user_settings['keybindings']['bob'] | safe}}, ()=>bell_obj.make_call("Bob"));
    Mousetrap.bind({{user_settings['keybindings']['single'] | safe}}, ()=>bell_obj.make_call("Single"));
    Mousetrap.bind({{user_settings['keybindings']['go'] | safe}}, ()=>bell_obj.make_call("Go"));
    Mousetrap.bind({{user_settings['keybindings']['all'] | safe}}, ()=>bell_obj.make_call("That's all"));
    Mousetrap.bind({{user_settings['keybindings']['stand'] | safe}}, ()=>bell_obj.make_call("Stand next"));
    Mousetrap.bind({{user_settings['keybindings']['look'] | safe}}, ()=>bell_obj.make_call("Look to"));
    Mousetrap.bind({{user_settings['keybindings']['rounds'] | safe}}, ()=>bell_obj.make_call("Rounds"));
    Mousetrap.bind({{user_settings['keybindings']['change'] | safe}}, ()=>bell_obj.make_call("Change method"));
    Mousetrap.bind({{user_settings['keybindings']['sorry'] | safe}}, ()=>bell_obj.make_call(window.tower_parameters.cur_user_name + " says sorry."));
}

{% endif %}

</script>
